<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>NW Newborn Clinical Guideline - Gestational Age Calculator</title>
    <link rel="stylesheet" href="../guidelinestyle.css" type="text/css" media="all">
    <link rel="stylesheet" href="src/main.css" type="text/css" media="all">
    <style>
        .lmp {
            color:darkgreen;
        }
        .edd {
            color:darkmagenta;
        }
        .hidden {
            visibility: hidden;
        }
    </style>
</head>

<body>
    <center>
        <form>
            <table border="0" cellspacing="0" cellpadding="2">
                <tbody>
                    <tr>
                        <td align="right"><label for="lmpDate" class="lmp">First day of LMP</label></td>
                        <td><input type="date" name="lmpDate" id="lmpDate" class="lmp"></td>
                    </tr>
                    <tr>
                        <td align="right"><label for="scanEdd" class="edd">EDD by scan or dates</label></td>
                        <td><input type="date" name="scanEdd" id="scanEdd" class="edd"></td>
                    </tr>
                    <tr>
                        <td align="right"><label for="targetDate">Calculate the gestation as of</label></td>
                        <td><input type="date" name="targetDate" id="targetDate" >
                    </tr>
                </tbody>
            </table>
            <hr>
            <button type="reset">Reset</button>
            <div class="output-container lmp hidden">The EDD from the LMP is <output id="eddByLmp"></output>
            </div>
            <div class="output-container lmp hidden">The gest age based on the LMP is <output id="lmpCgaWeeks"></output> weeks
                <sup>+<output id="lmpCgaDays"></output> day(s)</sup>
            </div>
            <div class="output-container edd hidden">The GA based on the presumed EDD is <output id="eddCgaWeeks"></output>
                weeks <sup>+<output id="eddCgaDays"></output> day(s)</sup>
            </div>
        </form>
    </center>
    <script src="../../GuidelineScript.js" type="text/javascript"></script>
    <script>
        /*MIT licence - https://github.com/brianblakely/nodep-date-input-polyfill*/
(function(){'use strict';var datePolyfillSrc="nodep-date-input-pollyfill.dist.js";(function(){var a=document.createElement("input");a.setAttribute("type","date");return a.setAttribute("value","not-a-date"),document.currentScript&&!document.currentScript.hasAttribute("data-nodep-date-input-polyfill-debug")&&"not-a-date"!==a.value})()||function(a,b){var c=document.createElement("script");c.src=a,c.onload=function(){b()},c.onerror=function(){throw new Error("Failed to load script "+a)},document.head.appendChild(c)}(datePolyfillSrc,function(){if("complete"===document.readyState)datePolyfill.addPickers();else{var a=!1;document.addEventListener("DOMContentLoaded",function(){a=!0,datePolyfill.addPickers()}),window.addEventListener("load",function(){a||datePolyfill.addPickers()})}})})();
    </script>
    <script type="text/javascript">
        (function() {
            const targetDateEl = document.getElementById('targetDate');
            const lmpDateEl = document.getElementById('lmpDate');
            const scanEddEl = document.getElementById('scanEdd');
            const msPerDay = 86400000;
            const termGestMs = 24192000000; // 40 weeks in ms
            const setValues = function() {
                if (!targetDateEl.valueAsDate) { setTargetNow(); }
                elChange({target: targetDateEl});
            }
            if ('valueAsDate' in targetDateEl) {
                setValues();
            } else { // for polyfill
                window.addEventListener('load', setValues);
            }

            [targetDateEl, lmpDateEl, scanEddEl].forEach(function(el) {
                el.addEventListener('input', elChange, { passive: true });
            });

            document.getElementsByTagName('form')[0].addEventListener('reset', function() {
                const cont = document.querySelectorAll('.output-container');
                for (let i = 0; i < cont.length; ++i) { //ie11 compat
                    cont[i].classList.add('hidden');
                }
                if (lmpDateEl.getAttribute('data-has-picker') !== null) { // this is if the datepicker polyfill is used
                    setTimeout(function() {
                        [lmpDateEl, scanEddEl].forEach(function(el) { 
                            el.value='';
                        });
                    }, 1);
                }
                setTimeout(setTargetNow, 1);
            });

            function setTargetNow() {
                const now = new Date();
                now.setTime(now.getTime() - now.getTimezoneOffset() * 60000); 
                targetDateEl.valueAsDate = now;
            }

            function elChange(evt) {
                const maxOverTermMs = 4233600000; // 7 weeks in ms - 3 weeks for over term and 4 weeks max difference dates/scan
                const overDatesMs = termGestMs + maxOverTermMs;
                const eddByLmpOut = document.getElementById('eddByLmp');
                const lmpWeeksOut = document.getElementById('lmpCgaWeeks');
                const lmpDaysOut = document.getElementById('lmpCgaDays');
                const eddWeeksOut = document.getElementById('eddCgaWeeks');
                const eddDaysOut = document.getElementById('eddCgaDays');
                const lmpDate = lmpDateEl.valueAsDate;
                const scanEdd = scanEddEl.valueAsDate;
                const targetDate = targetDateEl.valueAsDate;
                let lwd;
                let ewd;
                if (evt.target === targetDateEl) {
                    if (targetDate) {
                        lmpDateEl.min = asYMD(targetDate.getTime() - overDatesMs);
                        lmpDateEl.max = asYMD(targetDate)
                        scanEddEl.min = asYMD(targetDate.getTime() - maxOverTermMs);
                        scanEddEl.max = asYMD(targetDate.getTime() + overDatesMs);
                    } else {
                        lmpDateEl.min = lmpDateEl.max = scanEddEl.min = scanEddEl.max = '';
                    }
                } 
                if (lmpDate) {
                    const lmpEdd = new Date(lmpDate.getTime() + termGestMs); 
                    // ie 11 hack - doesn't have an output element with a value
                    eddByLmpOut.innerHTML = lmpEdd.toLocaleDateString(void 0, { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' });
                }
                containerVis(eddByLmpOut, lmpDate);
                if (targetDate) {
                    if (lmpDate) {
                        lwd = cgaByLMP(lmpDate, targetDate);
                        lmpWeeksOut.innerHTML = lwd.weeks;
                        lmpDaysOut.innerHTML = lwd.days
                    }
                    if (scanEdd) {
                        ewd = cgaByEDD(scanEdd, targetDate);
                        eddWeeksOut.innerHTML = ewd.weeks;
                        eddDaysOut.innerHTML = ewd.days
                    }
                }
                containerVis(lmpWeeksOut, lwd);
                containerVis(eddWeeksOut, ewd);
            }

            function containerVis(el, isVis) {
                do {
                    el = el.parentNode;
                } while(!el.classList.contains('output-container'));
                if (isVis) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            }
            function weeksDays(days) {
                let weeks = Math.floor(days / 7);
                days = Math.floor(days - weeks * 7);
                if (weeks > 44) { 
                    weeks = '> 43'; 
                    days = 'N/A';
                }
                if (weeks < 0) { 
                    weeks = '< 0'
                    days = 'N/A'
                }
                return { weeks: weeks, days: days }; // ie11 compatability!
            }
            function cgaByLMP(lmp, onDate) {
                let days = (onDate.getTime() - lmp.getTime()) / msPerDay;
                return weeksDays(days);
            }
            function cgaByEDD(edd, onDate) {
                let days = 280 - (edd.getTime() - onDate.getTime()) / msPerDay; // 280 = 40 weeks * 7 days/week
                return weeksDays(days);
            }

            function lang() {
                /// https://stackoverflow.com/questions/25606730/get-current-locale-of-chrome#answer-42070353
                if (window.navigator.languages) {
                    return window.navigator.languages[0];
                } else {
                    return window.navigator.userLanguage || window.navigator.language;
                }
            }

            function asYMD(dt) {
                if (typeof dt === 'number') {
                    dt = new Date(dt);
                }
                return dt.toISOString().substring(0, 10);
            }
        })();
    </script>
</body>

</html>